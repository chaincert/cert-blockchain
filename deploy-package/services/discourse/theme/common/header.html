<!-- Google tag (gtag.js) with Consent Mode -->
<script>
  // Set default consent to 'denied'
  window.dataLayer = window.dataLayer || [];
  function gtag() { dataLayer.push(arguments); }

  gtag('consent', 'default', {
    'analytics_storage': 'denied'
  });

  gtag('js', new Date());
  gtag('config', 'G-1WSBJNBM80', {
    'anonymize_ip': true
  });
</script>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-1WSBJNBM80"></script>

<!-- CERT Theme - Modern API -->
<script>
  (function () {
    'use strict';

    // Wait for Discourse to be ready
    if (typeof Discourse !== 'undefined') {
      Discourse.initializer({
        name: 'cert-theme-customizations',
        initialize() {
          // Add CERT branding class to body
          document.body.classList.add('cert-theme');

          // Initialize cookie consent banner
          initCookieConsent();
        }
      });
    } else {
      // Fallback if Discourse isn't loaded yet
      document.addEventListener('DOMContentLoaded', function () {
        document.body.classList.add('cert-theme');
        initCookieConsent();
      });
    }

    // Cookie Consent Management
    function initCookieConsent() {
      // Check if already initialized or user has made a choice
      if (document.getElementById('cert-cookie-banner') || localStorage.getItem('cookie-consent')) {
        if (localStorage.getItem('cookie-consent') === 'accepted') {
          enableAnalytics();
        }
        return;
      }

      // Create and show banner
      setTimeout(() => {
        const banner = createCookieBanner();
        document.body.appendChild(banner);
      }, 1000);
    }

    function enableAnalytics() {
      if (window.gtag) {
        window.gtag('consent', 'update', {
          'analytics_storage': 'granted'
        });
      }
    }

    function disableAnalytics() {
      if (window.gtag) {
        window.gtag('consent', 'update', {
          'analytics_storage': 'denied'
        });
      }
    }

    function createCookieBanner() {
      const banner = document.createElement('div');
      banner.id = 'cert-cookie-banner';
      banner.innerHTML = `
    <div style="position: fixed; bottom: 0; left: 0; right: 0; z-index: 9999; padding: 1rem;">
      <div style="max-width: 1200px; margin: 0 auto; background: linear-gradient(to right, rgba(15, 23, 42, 0.95), rgba(30, 41, 59, 0.95)); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; padding: 1.5rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);">
        <div style="display: flex; align-items: start; gap: 1rem; margin-bottom: 1rem;">
          <div style="width: 40px; height: 40px; border-radius: 0.5rem; background: rgba(0, 255, 163, 0.1); display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
            <span style="font-size: 1.25rem;">üç™</span>
          </div>
          <div style="flex: 1;">
            <h3 style="color: white; font-size: 1.125rem; font-weight: bold; margin: 0 0 0.5rem 0;">Cookie Preferences</h3>
            <p style="color: rgba(255, 255, 255, 0.7); margin: 0; font-size: 0.875rem;">
              We use cookies to improve your experience and analyze site traffic. By clicking "Accept", you consent to analytics cookies.
            </p>
          </div>
        </div>
        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
          <button id="cert-cookie-accept" style="flex: 1; min-width: 150px; padding: 0.75rem 1.5rem; background: linear-gradient(to right, #00FFA3, #4D9FFF); color: black; font-weight: 600; border: none; border-radius: 0.5rem; cursor: pointer;">
            Accept All Cookies
          </button>
          <button id="cert-cookie-decline" style="flex: 1; min-width: 150px; padding: 0.75rem 1.5rem; background: rgba(255, 255, 255, 0.05); color: white; font-weight: 600; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 0.5rem; cursor: pointer;">
            Decline Analytics
          </button>
        </div>
      </div>
    </div>
  `;

      // Add event listeners
      setTimeout(() => {
        document.getElementById('cert-cookie-accept').addEventListener('click', () => {
          localStorage.setItem('cookie-consent', 'accepted');
          enableAnalytics();
          banner.remove();
        });

        document.getElementById('cert-cookie-decline').addEventListener('click', () => {
          localStorage.setItem('cookie-consent', 'declined');
          disableAnalytics();
          banner.remove();
        });
      }, 0);

      return banner;
    }
  })();
</script>

<style>
  /* Header link back to main site */
  .cert-main-site {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    margin-right: 1rem;
    color: rgba(255, 255, 255, 0.6);
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .cert-main-site:hover {
    color: #00FFA3;
    border-color: rgba(0, 255, 163, 0.3);
    background: rgba(0, 255, 163, 0.05);
  }
</style>